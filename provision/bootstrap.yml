---
- hosts: all
  gather_facts: False
  tasks:
    - name: install Python 2
      raw: test -e /usr/bin/python || (apt-get update && apt-get install -y python)
    # TODO: propper reporting

    # TODO: extract to external file (this will be used by 2 playbooks)
    - set_fact:
        users:
            allgreed:
                ssh_public_key_location: "~/.ssh/id_rsa.pub"
            verisa:
                ssh_public_key_location: "~/.ssh/kot.pub"

    # TODO: convert this to a parametrized block - is this possible with ansible?
    # TODO: There has to be initial password, but have no idea what should it be - maybe use ansible Vault? + change manually?
    - name: add users
      user:
        user: "{{ item }}"
        shell: /bin/bash
        update_password: on_create
        append: yes
        groups: sudo
      loop: "{{ users | dict2items | map(attribute='key') | list }}"

    - name: insert ssh keys
      authorized_key:
        user: "{{ item.key }}"
        exclusive: no
        key: "{{ lookup('file', item.value.ssh_public_key_location) }}"
      loop: "{{ users | dict2items }}"

    # TODO: Block ssh auth by password
    # TODO: Lock root account (no one can log as root without sudo)
